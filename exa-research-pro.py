import requests
import time
import re




# ç ”ç©¶æç¤ºè¯
instructions = """
æ·±å…¥ç ”ç©¶ä¸‹é¢çš„è¯é¢˜ï¼šæ— é™ä¿¡æ¯ä¾›ç»™ä¸‹ï¼Œè¯¥ç”¨ä»€ä¹ˆæ ·çš„å¤„ç†ä¿¡æ¯çš„ç­–ç•¥ï¼Œä¸æ—§çš„ç­–ç•¥ç›¸æ¯”ï¼Ÿ


çŸ¥ä¹ä¸Šæœ‰å¾ˆå¤šå¥½å†…å®¹ï¼Œä¹Ÿæœ‰å¾ˆå¤šåå†…å®¹ã€‚
çŸ¥ä¹å†…å®¹ä¾›ç»™å¯¹æˆ‘æ¥è¯´ç›¸å½“äºæ˜¯æ— é™çš„ï¼Œå› ä¸ºæˆ‘çš„é˜…è¯»é€Ÿåº¦æœ‰é™ã€‚
æˆ‘æ²¡æœ‰åˆ·åˆ°ä¸€ä¸ªå¥½å†…å®¹ï¼Œæˆ‘æœ‰æŸå¤±å—ï¼Ÿçœ‹ä¸Šå»æˆ‘æŸå¤±äº†ä¸€ä¸ªå¥½ä¸œè¥¿ï¼Œä½†è€ƒè™‘åˆ°å¥½å†…å®¹æ˜¯æ— é™çš„ï¼Œå®é™…ä¸Šæˆ‘å·²ç»é”™è¿‡äº†æ— é™çš„å¥½å†…å®¹ï¼Œæˆ‘çœŸçš„é”™è¿‡äº†å—ï¼Ÿ

å¥½å†…å®¹åƒæ˜¯ä¸€æ¡å¥”æµä¸æ¯çš„å¤§æ²³ï¼Œè€Œä½ çš„æ³¨æ„åŠ›æ˜¯ä¸€ä¸ªå‹ºå­ã€‚ä½ æ²¡èˆ€èµ·æ¥çš„é‚£ä¸€å‹ºæ°´ï¼ˆé”™å¤±çš„ä¸€ä¸ªå¥½å†…å®¹ï¼‰ï¼Œæµèµ°äº†å°±æ˜¯æµèµ°äº†ã€‚ä½ ä¸éœ€è¦å–å…‰æ²³é‡Œæ‰€æœ‰çš„æ°´æ¥è§£æ¸´ï¼Œä½ åªéœ€è¦å–åˆ°ä½ é‚£ä¸€å‹ºå°±å¤Ÿäº†ã€‚å¦‚æœä½ å› ä¸ºâ€œé”™è¿‡äº†ä¸Šæ¸¸çš„æ°´â€è€Œæ„Ÿåˆ°ç„¦è™‘ï¼Œåè€Œä¼šæ´’æ‰æ‰‹é‡Œæ­£èˆ€ç€çš„æ°´ã€‚**åœ¨æ— é™çš„ä¿¡æ¯æµä¸­ï¼Œâ€œé”™è¿‡â€æ˜¯å¸¸æ€ï¼Œâ€œé‡è§â€æ‰æ˜¯å¥‡è¿¹ã€‚**

æ—¢ç„¶å¥½å†…å®¹æ˜¯æ— é™çš„ï¼Œé‚£ä¹ˆâ€œé”™è¿‡ä¸€ä¸ªå¥½å†…å®¹â€æœ¬èº«ä¸æ˜¯æŸå¤±ã€‚**çœŸæ­£çš„æŸå¤±å‘ç”Ÿåœ¨ä½ æ¶ˆè´¹â€œåå†…å®¹â€çš„é‚£ä¸€åˆ»ã€‚**
-   **æ—¶é—´åšå¼ˆ**ï¼šä½ çš„ç”Ÿå‘½ï¼ˆé˜…è¯»æ—¶é—´ï¼‰æ˜¯æœ‰é™çš„ï¼Œè¿™æ‰æ˜¯å”¯ä¸€çš„ç¨€ç¼ºèµ„æºã€‚
-   **åŠ£å¸é©±é€è‰¯å¸**ï¼šå½“ä½ èŠ±10åˆ†é’Ÿçœ‹äº†ä¸€ä¸ªåƒåœ¾å†…å®¹ï¼Œè¿™10åˆ†é’Ÿå°±æ°¸è¿œæ¶ˆå¤±äº†ã€‚è¿™ä¸ä»…æ„å‘³ç€ä½ æ²¡çœ‹åˆ°é‚£ä¸ªâ€œæ½œåœ¨çš„å¥½å†…å®¹â€ï¼Œæ›´æ„å‘³ç€ä½ çš„ç”Ÿå‘½è¢«ä½è´¨é‡çš„ä¿¡æ¯å¡«å……äº†ã€‚
-   **ç»“è®º**ï¼š**æŸå¤±ä¸åœ¨äºâ€œæ²¡çœ‹è§ä»€ä¹ˆâ€ï¼Œè€Œåœ¨äºâ€œçœ‹è§äº†ä»€ä¹ˆâ€ã€‚** åªæœ‰å½“ä½ æŠŠæ—¶é—´æµªè´¹åœ¨åƒåœ¾ä¸Šæ—¶ï¼Œä½ æ‰çœŸçš„é­å—äº†æŸå¤±ã€‚


- **å†…å®¹çš„æ¶æ€§é€šèƒ€**ï¼šåœ¨äº’è”ç½‘æ—¶ä»£ï¼Œå¥½å†…å®¹è™½ç„¶æ¯”åå†…å®¹å°‘ï¼Œä½†ç»å¯¹æ•°é‡ä¾ç„¶æ˜¯å¤©æ–‡æ•°å­—ã€‚å¯¹äºä¸ªä½“è€Œè¨€ï¼Œâ€œå¥½å†…å®¹â€å·²ç»å‘ç”Ÿäº†æ¶æ€§é€šèƒ€ã€‚å½“è´§å¸ï¼ˆå¥½å†…å®¹ï¼‰æ— é™å¢å‘æ—¶ï¼Œå•æšè´§å¸çš„ä»·å€¼å°±æ— é™è¶‹è¿‘äºé›¶ã€‚
- **æ³¨æ„åŠ›çš„ç»å¯¹é€šç¼©**ï¼šä½ å”¯ä¸€çœŸæ­£ç¨€ç¼ºçš„èµ„æºæ˜¯ä½ çš„â€œç”Ÿå‘½æ—¶é•¿â€å’Œâ€œè®¤çŸ¥å¸¦å®½â€ã€‚
- **ç»“è®º**ï¼šä½ å¹¶æ²¡æœ‰é”™è¿‡å¥½å†…å®¹ï¼Œå› ä¸ºåœ¨â€œæ— é™ä¾›ç»™â€é¢å‰ï¼Œå•ç¯‡å†…å®¹çš„è¾¹é™…ä»·å€¼å‡ ä¹ä¸ºé›¶ã€‚çœŸæ­£çš„æŸå¤±ä¸æ˜¯â€œæ²¡çœ‹åˆ°æŸä¸ªå¥½ä¸œè¥¿â€ï¼Œè€Œæ˜¯â€œä¸ºäº†å¯»æ‰¾å¥½ä¸œè¥¿è€Œæµªè´¹äº†ç¨€ç¼ºçš„æ³¨æ„åŠ›â€ã€‚

ç­›é€‰æˆæœ¬ä¸æœºä¼šæˆæœ¬
- **æ·˜é‡‘çš„ä»£ä»·**ï¼šå‡è®¾æ²™å­é‡Œæ··ç€é‡‘å­ï¼ˆå¥½å†…å®¹ï¼‰ã€‚å¦‚æœä½ ä¸ºäº†ä¸é”™è¿‡ä»»ä½•ä¸€é¢—é‡‘å­ï¼Œè€ŒæŠŠæ•´æ¡æ²³çš„æ²™å­éƒ½ç­›ä¸€éï¼Œä½ ä»˜å‡ºçš„ä½“åŠ›ï¼ˆæ—¶é—´ç²¾åŠ›ï¼‰å¯èƒ½è¿œè¶…é‡‘å­çš„ä»·å€¼ã€‚
- **é”™è¿‡çš„å¿…è¦æ€§**ï¼šä¸ºäº†é‡åˆ°é‚£å‡ ä¸ªçœŸæ­£å¯¹ä½ æœ‰å¯å‘çš„â€œå¥½å†…å®¹â€ï¼Œä½ å¿…é¡»æˆ˜ç•¥æ€§åœ°æ”¾å¼ƒç»å¤§å¤šæ•°â€œè¿˜ä¸é”™çš„å†…å®¹â€ã€‚
- **ç»“è®º**ï¼š**â€œé”™è¿‡â€ä¸æ˜¯ä¸€ç§é—æ†¾ï¼Œè€Œæ˜¯ä¸€ç§ç­›é€‰æœºåˆ¶ã€‚** åªæœ‰å¦ç„¶æ¥å—â€œé”™è¿‡æ— é™çš„å¥½å†…å®¹â€ï¼Œä½ æ‰èƒ½ä»ç„¦è™‘ä¸­è§£è„±å‡ºæ¥ï¼Œå»äº«å—çœ¼å‰è¿™ä¸€åˆ»çš„å†…å®¹ã€‚
"""

# post_url = "https://api.exa.ai/research/v1"
# API_KEY = "21d04e51-30ca-47ec-bcb3-829fde2623ec"


# APIé…ç½®
post_url = "http://exa.firstsound.me/research/v1"
API_KEY = "sk-linuxdo"

## https://linux.do/t/topic/1356815

headers = {
    "content-type": "application/json",
    "x-api-key": API_KEY
}

payload = {
    "instructions": instructions,
    "model": "exa-research-pro"
}

# æäº¤ä»»åŠ¡
response = requests.post(post_url, json=payload, headers=headers)
task_data = response.json()
print("ä»»åŠ¡æäº¤ç»“æœ:", task_data)

# è·å–ä»»åŠ¡ ID
task_id = task_data.get("researchId") or task_data.get("id")

if task_id:
    print(f"ç­‰å¾…ä»»åŠ¡ {task_id} å¤„ç†ä¸­...")
    
    # è½®è¯¢æŸ¥è¯¢ç»“æœ
    get_url = f"{post_url}/{task_id}"
    while True:
        result_response = requests.get(get_url, headers=headers)
        result_data = result_response.json()
        status = result_data.get("status", "")
        print(f"å½“å‰çŠ¶æ€: {status}")
        
        if status == "completed":
            print("ç ”ç©¶å®Œæˆ!")
            
            # è·å–è¾“å‡ºå†…å®¹
            content = result_data.get("output", {}).get("content", "")
            
            # è·å–å¼•ç”¨ä¿¡æ¯
            citations = result_data.get("citations", [])
            
            # ä»å†…å®¹ä¸­æå–æ ‡é¢˜ä½œä¸ºæ–‡ä»¶å
            lines = content.strip().split('\n')
            title = "research_result"
            for line in lines:
                if line.startswith('# '):
                    title = line[2:].strip()
                    break
            
            # æ¸…ç†æ–‡ä»¶åä¸­çš„éæ³•å­—ç¬¦
            filename = re.sub(r'[\\/*?:"<>|]', '_', title)
            filename = filename[:50]  # é™åˆ¶é•¿åº¦
            filepath = f"{filename}.md"
            
            # æ„å»ºä¼˜åŒ–åçš„markdownå†…å®¹
            md_content = content
            
            # æ·»åŠ å¼•ç”¨æ¥æºéƒ¨åˆ†
            md_content += "\n\n---\n\n## ğŸ“š å‚è€ƒæ¥æº\n\n"
            for i, cite in enumerate(citations, 1):
                cite_title = cite.get("title", "æœªçŸ¥æ ‡é¢˜")
                cite_url = cite.get("url", "")
                if cite_url and cite_title:
                    md_content += f"{i}. [{cite_title}]({cite_url})\n"
            
            # æ·»åŠ å…ƒä¿¡æ¯
            cost_info = result_data.get("costDollars", {})
            md_content += f"\n\n---\n\n*ç ”ç©¶æˆæœ¬: ${cost_info.get('total', 0):.4f} | æœç´¢é¡µæ•°: {cost_info.get('numPages', 0)} | æœç´¢æ¬¡æ•°: {cost_info.get('numSearches', 0)}*\n"
            
            # å†™å…¥markdownæ–‡ä»¶
            with open(filepath, 'w', encoding='utf-8') as f:
                f.write(md_content)
            print(f"ç»“æœå·²ä¿å­˜åˆ°: {filepath}")
            break
        elif status == "failed":
            print("ç ”ç©¶å¤±è´¥:", result_data)
            break
        else:
            print("ç­‰å¾…ä¸­...")
            time.sleep(10)  # æ¯10ç§’è½®è¯¢ä¸€æ¬¡
else:
    print("ä»»åŠ¡æäº¤å¤±è´¥ï¼Œæ— æ³•è·å–ä»»åŠ¡ID")
